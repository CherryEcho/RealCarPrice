<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>PCP & Financing Playground — Real Cost Calculator (v7) — Improved sliders (v6)</title>
<style>
:root{
  --bg:#0f1724;--card:#071122;--muted:#9aa4b2;--accent:#00d1b2;--glass:rgba(255,255,255,0.03);
  --highlight:rgba(0,209,178,0.12);color-scheme:dark;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,'Helvetica Neue',Arial,sans-serif;
  background:linear-gradient(180deg,#071026 0%, #071a2b 100%);color:#e6eef6;}
.container{max-width:1100px;margin:18px auto;padding:12px;position:relative}
.card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:12px;padding:12px;box-shadow:0 8px 30px rgba(2,6,23,0.6)}
.header{display:flex;align-items:center;gap:12px;justify-content:space-between}
h1{margin:0;font-size:18px}
.subtitle{color:var(--muted);font-size:13px;margin-top:6px}
.row{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
.col{flex:1 1 240px;min-width:200px;position:relative}
.control-box{padding:12px;border-radius:10px;background:rgba(255,255,255,0.01);border:1px solid rgba(255,255,255,0.03)}
.label-row{display:flex;justify-content:space-between;align-items:center;gap:8px}
label{display:block;font-size:13px;color:var(--muted);margin-bottom:8px;cursor:pointer}
input[type=range]{width:100%;height:40px;background:transparent;margin:0;padding:0;touch-action:pan-x;-webkit-appearance:none;}
input,select,textarea{box-sizing:border-box;width:100%}
input[type=range]::-webkit-slider-runnable-track{height:10px;background:rgba(255,255,255,0.06);border-radius:999px}
input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;height:28px;width:28px;border-radius:50%;background:var(--accent);margin-top:-9px;box-shadow:0 6px 18px rgba(0,0,0,0.45);border:3px solid rgba(255,255,255,0.06)}
input[type=range]::-moz-range-track{height:10px;background:rgba(255,255,255,0.06);border-radius:999px}
input[type=range]::-moz-range-thumb{height:28px;width:28px;border-radius:50%;background:var(--accent);box-shadow:0 6px 18px rgba(0,0,0,0.45);border:3px solid rgba(255,255,255,0.06)}

.value{font-size:15px;font-weight:700;color:#fff;margin-top:8px;display:flex;gap:8px;align-items:center}
.value .muted{color:var(--muted);font-weight:600;font-size:13px}
.range-bubble{position:absolute;transform:translate(-50%,-120%);top:8px;background:#02121a;color:#cfeee3;padding:6px 8px;border-radius:10px;box-shadow:0 10px 30px rgba(0,0,0,0.4);font-weight:700;font-size:13px;white-space:nowrap;pointer-events:none;z-index:8;display:none;max-width:60%;overflow:hidden;text-overflow:ellipsis}
.range-meta{display:flex;justify-content:space-between;font-size:12px;color:var(--muted);margin-top:6px}

/* deal parameters grid and clipping fixes */
.deal-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:8px;align-items:start}
.deal-grid .col{min-width:0;box-sizing:border-box}
.deal-grid input{width:100%;box-sizing:border-box}

/* outputs */
.outputs{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-top:10px}
.out{background:rgba(255,255,255,0.03);padding:10px;border-radius:8px}
.out .k{font-size:12px;color:var(--muted)} .out .v{font-size:15px;font-weight:700}
.grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-top:10px}
.small{font-size:12px;color:var(--muted)}
.btn{background:var(--accent);color:#052026;padding:8px 10px;border-radius:10px;font-weight:700;border:none;cursor:pointer; touch-action:manipulation}
.btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted);padding:7px 10px;border-radius:8px;cursor:pointer; touch-action:manipulation}
.footer{margin-top:10px;color:var(--muted);font-size:12px}

/* Tooltip */
.tooltip{position:absolute;background:#02121a;color:#cfeee3;padding:12px;border-radius:10px;box-shadow:0 12px 40px rgba(0,0,0,0.6);max-width:340px;font-size:13px;z-index:12010;line-height:1.35;opacity:0;transform:translateY(6px);transition:opacity .18s ease, transform .18s ease;pointer-events:auto}
.tooltip.visible{opacity:1;transform:translateY(0)} .tooltip::after{content:"";position:absolute;width:10px;height:10px;transform:rotate(45deg);background:#02121a;left:50%;margin-left:-5px;top:-5px}

/* responsive tweaks */
@media(max-width:900px){.outputs{grid-template-columns:repeat(2,1fr)}.grid-3{grid-template-columns:1fr}.header{flex-direction:column;align-items:flex-start}.subtitle{font-size:12px}.container{padding:10px;margin:8px}canvas{height:220px!important}}
@media(max-width:520px){.outputs{grid-template-columns:1fr}.row{gap:8px}.col{min-width:140px}.value{font-size:14px}h1{font-size:16px}.tooltip{max-width:90%;font-size:13px}.range-bubble{display:block}}
</style>
</head>
<body>
<div class="container card" id="app">
  <div class="header">
    <div>
      <h1 id="title">PCP & Financing Playground — Real Cost Calculator (v7)</h1>
      <div class="subtitle" id="subtitle">Compare paying cash vs spreading payments. Experiment with returns, inflation, tax, loan APR and balloon options. Works offline.</div>
    </div>
    <div class="inline">
      <button id="helpBtn" class="btn-ghost" title="Open help and FAQ">Help / FAQ</button>
      <button id="downloadBtn" class="btn" title="Download a snapshot HTML of this page">Download HTML</button>
      <button id="exportCsvBtn" class="btn-ghost" title="Export summary CSV">Export summary CSV</button>
      <button id="exportMonthlyCsvBtn" class="btn-ghost" title="Export monthly CSV">Export monthly CSV</button>
    </div>
  </div>

  <div style="margin-top:10px" class="card">
    <div class="small" style="font-weight:600;color:#fff">Deal parameters (edit before adjusting sliders)</div>
    <div class="deal-grid" style="margin-top:8px">
      <div class="col control-box">
        <label data-tip="Total on-the-road cash price of the car.">On-the-road price (£)</label>
        <input id="price" type="number" inputmode="numeric" pattern="[0-9]*" value="39990" aria-label="Price in pounds">
      </div>
      <div class="col control-box">
        <label data-tip="Amount you pay up front (before dealer contribution).">Customer deposit (£)</label>
        <input id="cust_dep" type="number" inputmode="numeric" pattern="[0-9]*" value="8600">
      </div>
      <div class="col control-box">
        <label data-tip="Dealer or manufacturer contribution to the deposit (reduces your outlay).">Dealer contribution (£)</label>
        <input id="tesla_contrib" type="number" inputmode="numeric" pattern="[0-9]*" value="3000">
      </div>
      <div class="col control-box">
        <label data-tip="Monthly repayment you make (or will be computed from APR if that option is checked).">Monthly payment (£)</label>
        <input id="monthly" type="number" inputmode="numeric" pattern="[0-9]*" value="299">
      </div>
      <div class="col control-box">
        <label data-tip="Number of monthly payments you'll make (excluding final balloon month).">Monthly payments (count)</label>
        <input id="nmonthly" type="number" inputmode="numeric" pattern="[0-9]*" value="47">
      </div>
      <div class="col control-box">
        <label data-tip="Optional final balloon payment at the end if you keep the car. Uncheck 'I'll pay the balloon' to set to zero.">Optional final payment (balloon)</label>
        <input id="balloon" type="number" inputmode="numeric" pattern="[0-9]*" value="17334">
      </div>
    </div>
    <div class="small" style="margin-top:8px">Tip: check "Compute monthly from Loan APR" below to auto-calc monthly payment from APR, financed amount and balloon.</div>
  </div>

  <div class="row" style="margin-top:10px;">
    <div class="col control-box" data-control="nominal">
      <div class="label-row">
        <label for="nominal" data-tip="Investment return you expect to earn on investments before tax.">Investment return</label>
        <span id="nominal_val" aria-live="polite" data-tip="Investment return displayed as a percentage">5.0%</span>
      </div>
      <input id="nominal" type="range" min="0" max="12" step="0.1" value="5" aria-label="Investment return">
      <div class="range-meta"><span class="min">0%</span><span class="max">12%</span></div>
      <div class="value"><span class="muted">after tax:</span> <span id="nominal_after_tax" aria-live="polite" data-tip="Investment return after applying the tax slider.">3.75%</span></div>
    </div>

    <div class="col control-box" data-control="inflation">
      <div class="label-row">
        <label for="inflation" data-tip="General price inflation used to compute the real discount rate (reduces purchasing power).">Inflation</label>
        <span id="inflation_val" aria-live="polite" data-tip="Inflation as percent">3.0%</span>
      </div>
      <input id="inflation" type="range" min="0" max="8" step="0.1" value="3" aria-label="Inflation">
      <div class="range-meta"><span class="min">0%</span><span class="max">8%</span></div>
    </div>

    <div class="col control-box" data-control="tax">
      <div class="label-row">
        <label for="tax" data-tip="Tax applied to investment gains. Use the toggle to apply tax to nominal or inflation-adjusted (real) returns.">Tax rate on returns</label>
        <span id="tax_val" aria-live="polite" data-tip="This percentage reduces your nominal returns when tax-on-nominal is selected.">25.0%</span>
      </div>
      <input id="tax" type="range" min="0" max="60" step="0.5" value="25" aria-label="Tax rate">
      <div class="range-meta"><span class="min">0%</span><span class="max">60%</span></div>
      <div class="value">
        <div class="toggle" style="display:inline-flex;align-items:center;gap:8px">
          <input id="tax_on_real" type="checkbox"><label for="tax_on_real" class="small">Apply tax to inflation-adjusted (real) returns</label>
        </div>
      </div>
    </div>
  </div>

  <div class="row" style="margin-top:8px;">
    <div class="col control-box">
      <div class="label-row">
        <label for="loan_apr" data-tip="Annual percentage rate for the loan. If 'Compute monthly from Loan APR' is checked, monthly payments are calculated from this APR.">Loan APR (%)</label>
        <span id="loan_apr_span" data-tip="APR used to compute monthly payment when selected.">0.00%</span>
      </div>
      <input id="loan_apr" type="number" step="0.01" value="0.00" aria-label="Loan APR">
      <div class="small" style="margin-top:6px">Set loan APR to see financing scenarios.</div>
      <div class="toggle"><input id="use_loan_apr" type="checkbox"><label for="use_loan_apr" class="small">Compute monthly payment from Loan APR</label></div>
    </div>
    <div class="col control-box">
      <div class="label-row">
        <label data-tip="If checked, the balloon payment is included at the end; otherwise the balloon is set to zero (model returning the car).">Balloon option</label>
        <span data-tip="Toggle to model paying or returning the car.">Pay</span>
      </div>
      <div class="toggle" style="margin-top:8px"><input id="pay_balloon" type="checkbox" checked><label for="pay_balloon" class="small">I'll pay the balloon at the end</label></div>
      <div class="small" style="margin-top:6px">Uncheck to model returning the car at end of PCP (no balloon payment).</div>
    </div>
    <div class="col control-box">
      <label style="font-weight:400;color:var(--muted)">Misc</label>
      <div class="small">Edit deal parameters above. Chart and exports update live.</div>
    </div>
  </div>

  <div class="outputs" style="margin-top:10px">
    <div class="out"><div class="k">Real discount rate (annual)</div><div class="v" id="real_rate">—</div></div>
    <div class="out"><div class="k">Start invested (nominal)</div><div class="v" id="start_inv">—</div></div>
    <div class="out"><div class="k">Final nominal balance (after term)</div><div class="v" id="final_bal">—</div></div>
    <div class="out"><div class="k">Effective price today (your cost)</div><div class="v" id="eff_price">—</div></div>
    <div class="out"><div class="k">Saving vs paying cash today</div><div class="v" id="saving">—</div></div>
    <div class="out"><div class="k">Cumulative interest earned (nominal)</div><div class="v" id="cum_interest">—</div></div>
    <div class="out"><div class="k">Monthly payment used</div><div class="v" id="monthly_used">—</div></div>
    <div class="out"><div class="k">Financed amount</div><div class="v" id="financed_amount">—</div></div>
  </div>

  <div class="grid-3" style="margin-top:10px">
    <div class="card" style="padding:10px;text-align:center">
      <canvas id="chart" width="520" height="300"></canvas>
      <div class="legend"><div style="width:10px;height:10px;background:#00d1b2;border-radius:2px"></div><div>Invested balance (nominal)</div></div>
    </div>
    <div class="card" style="padding:10px">
      <div class="small">Quick actions</div>
      <div style="height:8px"></div>
      <button id="copyBtn" class="btn-ghost">Copy key numbers to clipboard</button>
      <div id="copystatus" style="margin-top:8px"></div>
      <div style="height:12px"></div>
      <div class="small">Notes</div>
      <div class="small" style="margin-top:6px">Effective price = PV of your payments (net deposit + discounted monthly payments + discounted balloon), using the configured real discount rate.</div>
    </div>
    <div class="card" style="padding:10px">
      <div class="small">Export</div>
      <div style="height:8px"></div>
      <button id="exportSummaryBtn" class="btn-ghost">Export summary CSV (2dp)</button>
      <button id="exportMonthlyBtn" class="btn-ghost" style="margin-top:8px">Export monthly CSV with interest (2dp)</button>
      <div style="height:12px"></div>
      <div class="small">Monthly CSV columns: month, start_balance, interest_earned, withdrawal, end_balance, cumulative_interest.</div>
    </div>
  </div>

  <div class="footer small">To host this page online, upload the HTML file to GitHub Pages or Netlify. Use "Download HTML" to save a snapshot.</div>
  <div id="tooltip" class="tooltip" role="tooltip" aria-hidden="true"></div>
</div>

<div id="modalBackdrop" class="modal-backdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="helpTitle">
    <button class="close-x" id="modalClose" title="Close">✕</button>
    <h2 id="helpTitle">Help & FAQ</h2>
    <p>Tap the ℹ️ icon, the label, or the numeric value next to a control to open a tooltip. The tooltip will remain open until you tap anywhere outside it. Press <kbd>Esc</kbd> to dismiss on keyboard.</p>
    <div style="margin-top:10px;text-align:right"><button id="modalClose2" class="btn">Close</button></div>
  </div>
</div>

<script>
// small helpers
const fmt = x => '£' + Number(x).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});

// elements
const container = document.getElementById('app');
const tooltip = document.getElementById('tooltip');
const nominal = document.getElementById('nominal'), inflation = document.getElementById('inflation'), tax = document.getElementById('tax');
const nominal_val = document.getElementById('nominal_val'), inflation_val = document.getElementById('inflation_val'), tax_val = document.getElementById('tax_val');
const nominal_after_tax = document.getElementById('nominal_after_tax');
const price = document.getElementById('price'), cust_dep = document.getElementById('cust_dep'), tesla_contrib = document.getElementById('tesla_contrib');
const monthly = document.getElementById('monthly'), nmonthly = document.getElementById('nmonthly'), balloon = document.getElementById('balloon');

// state for tooltip persistence
let activeTipEl = null;
let lastTooltipOpened = 0;

function computeTooltipPosition(el){
  const rect = el.getBoundingClientRect();
  const crect = container.getBoundingClientRect();
  const width = Math.min(340, Math.max(220, rect.width*2));
  let left = (rect.left - crect.left) + rect.width/2 - width/2;
  left = Math.max(8, Math.min(crect.width - width - 8, left));
  let top = (rect.top - crect.top) + rect.height + 12;
  const estH = tooltip.offsetHeight || 64;
  if(top + estH + 12 > crect.height) top = (rect.top - crect.top) - estH - 12;
  if(top < 8) top = 8;
  return {left, top, width};
}

function showTooltipForElement(el){
  if(!el) return;
  const tip = el.getAttribute('data-tip');
  if(!tip) return;
  if(activeTipEl === el){ hideTooltip(); return; }
  if(activeTipEl && activeTipEl !== el){
    const prev = activeTipEl.closest('.col') || activeTipEl.closest('label') || activeTipEl;
    if(prev) prev.classList.remove('active-tip');
  }
  activeTipEl = el;
  tooltip.textContent = tip;
  tooltip.classList.add('visible');
  tooltip.setAttribute('aria-hidden','false');
  const containerEl = el.closest('.col') || el.closest('label') || el;
  if(containerEl) containerEl.classList.add('active-tip');
  tooltip.style.width = '';
  lastTooltipOpened = Date.now();
  requestAnimationFrame(()=>{
    const pos = computeTooltipPosition(el);
    tooltip.style.left = pos.left + 'px';
    tooltip.style.top = pos.top + 'px';
    tooltip.style.width = pos.width + 'px';
  });
  document.addEventListener('keydown', escHandler);
  window.addEventListener('resize', repositionTooltip);
  window.addEventListener('scroll', repositionTooltip, true);
}

function hideTooltip(){
  if(!tooltip.classList.contains('visible')) return;
  tooltip.classList.remove('visible');
  tooltip.setAttribute('aria-hidden','true');
  if(activeTipEl){
    const prev = activeTipEl.closest('.col') || activeTipEl.closest('label') || activeTipEl;
    if(prev) prev.classList.remove('active-tip');
    activeTipEl = null;
  }
  document.removeEventListener('keydown', escHandler);
  window.removeEventListener('resize', repositionTooltip);
  window.removeEventListener('scroll', repositionTooltip, true);
}

function repositionTooltip(){
  if(!activeTipEl) return;
  const pos = computeTooltipPosition(activeTipEl);
  tooltip.style.left = pos.left + 'px';
  tooltip.style.top = pos.top + 'px';
}

function escHandler(e){ if(e.key === 'Escape' || e.key === 'Esc') hideTooltip(); }

// attach handlers to data-tip elements
document.querySelectorAll('[data-tip]').forEach(el=>{
  el.addEventListener('touchstart', (ev)=>{ ev.stopPropagation && ev.stopPropagation(); showTooltipForElement(el); }, {passive:true});
  el.addEventListener('click', (ev)=>{ ev.stopPropagation && ev.stopPropagation(); showTooltipForElement(el); });
  if(window.matchMedia('(hover: hover) and (pointer: fine)').matches){
    el.addEventListener('mouseenter', ()=> showTooltipForElement(el));
    el.addEventListener('mouseleave', ()=> hideTooltip());
  }
});

// hide when tapping/clicking outside — ignore taps that happen immediately after opening
document.addEventListener('click', (e)=>{
  if(e.target.closest('[data-tip]')) return;
  if(e.target.closest('#tooltip')) return;
  if(Date.now() - lastTooltipOpened < 450) return;
  hideTooltip();
});
document.addEventListener('touchstart', (e)=>{
  if(e.target.closest('[data-tip]')) return;
  if(e.target.closest('#tooltip')) return;
  if(Date.now() - lastTooltipOpened < 450) return;
  hideTooltip();
}, {passive:true});

// prevent focus race from hiding tooltip when tapping labels/values
document.querySelectorAll('input, select, textarea, button').forEach(el=>{
  el.addEventListener('focus', ()=>{
    setTimeout(()=>{
      const focused = document.activeElement;
      if(activeTipEl && focused && focused.closest && activeTipEl.closest && focused.closest('.col') === activeTipEl.closest('.col')) return;
      if(Date.now() - lastTooltipOpened > 400) hideTooltip();
    }, 80);
  });
});

// range visuals (bubble & fill)
function updateRangeVisual(rangeEl){
  const min = parseFloat(rangeEl.min)||0; const max = parseFloat(rangeEl.max)||100;
  const val = parseFloat(rangeEl.value);
  const pct = ((val-min)/(max-min))*100;
  rangeEl.style.background = `linear-gradient(90deg, var(--accent) ${pct}%, rgba(255,255,255,0.06) ${pct}%)`;
  const col = rangeEl.closest('.col'); if(!col) return;
  let bubble = col.querySelector('.range-bubble');
  if(!bubble){ bubble = document.createElement('span'); bubble.className='range-bubble'; col.appendChild(bubble); }
  const step = parseFloat(rangeEl.step)||1; const decimals = ((''+step).includes('.'))?step.toString().split('.')[1].length:0;
  bubble.textContent = Number(val).toFixed(decimals) + '%';
  const rect = rangeEl.getBoundingClientRect(); const crect = col.getBoundingClientRect();
  const left = ((pct/100)*rect.width) + (rect.left - crect.left);
  bubble.style.left = left + 'px';
  if(window.matchMedia('(hover: none)').matches) bubble.style.display='block'; else if(rangeEl.matches(':active')) bubble.style.display='block'; else bubble.style.display='none';
}

function initRangeUI(){
  document.querySelectorAll('input[type=range]').forEach(r=>{
    const col = r.closest('.col');
    if(col && !col.querySelector('.range-bubble')){ const b = document.createElement('span'); b.className='range-bubble'; col.appendChild(b); }
    updateRangeVisual(r);
    r.addEventListener('input', ()=>{ updateRangeVisual(r); refresh(); });
    r.addEventListener('pointerdown', ()=>{ const b = r.closest('.col').querySelector('.range-bubble'); if(b) b.style.display='block'; });
    r.addEventListener('pointerup', ()=>{ const b = r.closest('.col').querySelector('.range-bubble'); if(b && window.matchMedia('(hover: hover)').matches) b.style.display='none'; });
    r.addEventListener('pointerenter', ()=>{ if(window.matchMedia('(hover: hover)').matches){ const b = r.closest('.col').querySelector('.range-bubble'); if(b) b.style.display='block'; } });
    r.addEventListener('pointerleave', ()=>{ if(window.matchMedia('(hover: hover)').matches){ const b = r.closest('.col').querySelector('.range-bubble'); if(b) b.style.display='none'; } });
    window.addEventListener('resize', ()=> updateRangeVisual(r));
    window.addEventListener('scroll', ()=> updateRangeVisual(r), true);
  });
}

// core compute (same as before but minimal exports omitted for brevity)
function computeMonthlyFromAPR(financed, apr_annual, n, balloon_val){
  if(n <= 0) return 0;
  const r = Math.pow(1+apr_annual,1/12)-1;
  const discounted_balloon = balloon_val / Math.pow(1+r,n);
  const numerator = (financed - discounted_balloon) * r;
  const denom = 1 - Math.pow(1+r,-n);
  if(Math.abs(denom) < 1e-12) return 0;
  return numerator/denom;
}

function getState(){
  const nom = parseFloat(nominal.value)/100 || 0;
  const inf = parseFloat(inflation.value)/100 || 0;
  const taxRate = parseFloat(tax.value)/100 || 0;
  const tax_on_real = document.getElementById('tax_on_real').checked;
  const loan_apr = parseFloat(document.getElementById('loan_apr').value)/100 || 0;
  const use_loan_apr = document.getElementById('use_loan_apr').checked;
  const pay_balloon = document.getElementById('pay_balloon').checked;
  const P = parseFloat(price.value) || 0;
  const cust = parseFloat(cust_dep.value) || 0;
  const tcont = parseFloat(tesla_contrib.value) || 0;
  const net_dep = cust - tcont;
  const mpay_input = parseFloat(monthly.value) || 0;
  const npay = parseInt(nmonthly.value) || 0;
  const balloon_input = parseFloat(balloon.value) || 0;
  const balloon_val = pay_balloon ? balloon_input : 0;
  const start_invested = P - net_dep;
  const financed_amount = P - cust;

  let after_tax_nom, real_annual;
  if(!tax_on_real){
    after_tax_nom = nom * (1 - taxRate);
    real_annual = (1 + after_tax_nom)/(1 + inf) - 1;
  } else {
    const real_before_tax = (1+nom)/(1+inf)-1;
    const after_tax_real = real_before_tax * (1 - taxRate);
    real_annual = after_tax_real;
    after_tax_nom = Math.pow((1 + after_tax_real)*(1 + inf), 1) - 1;
  }

  const r_month_nom = Math.pow(1 + (after_tax_nom||0), 1/12) - 1;
  const r_month_real = Math.pow(1 + real_annual, 1/12) - 1;
  let monthly_used = mpay_input;
  if(use_loan_apr) monthly_used = computeMonthlyFromAPR(financed_amount, loan_apr, npay, balloon_val);

  let balances=[start_invested], interest_arr=[0], cum_interest=0, b=start_invested;
  for(let m=1;m<=npay+1;m++){
    const before=b;
    b = b * (1 + r_month_nom);
    const interest_earned = b - before;
    cum_interest += interest_earned;
    let withdrawal = 0;
    if(m <= npay){ withdrawal = monthly_used; b -= monthly_used; } else { withdrawal = balloon_val; b -= balloon_val; }
    balances.push(b); interest_arr.push(interest_earned);
  }

  let pv_monthly = 0;
  for(let k=1;k<=npay;k++) pv_monthly += monthly_used / Math.pow(1 + r_month_real, k);
  const pv_balloon = balloon_val / Math.pow(1 + r_month_real, npay+1);
  const pv_total = net_dep + pv_monthly + pv_balloon;
  const saving = P - pv_total;
  const final_nominal = balances[balances.length-1];

  return {nom,inf,taxRate,net_dep,financed_amount,monthly_used,npay,balloon_val,start_invested,real_annual,balances,interest_arr,cumulative_interest:cum_interest,pv_total,saving,after_tax_nom,final_nominal};
}

function refresh(){
  const s = getState();
  nominal_val.textContent = (s.nom*100).toFixed(1) + '%';
  inflation_val.textContent = (s.inf*100).toFixed(1) + '%';
  tax_val.textContent = (s.taxRate*100).toFixed(1) + '%';
  nominal_after_tax.textContent = ((s.after_tax_nom||0)*100).toFixed(2) + '%';
  document.getElementById('start_inv') && (document.getElementById('start_inv').textContent = fmt(s.start_invested));
  document.getElementById('final_bal') && (document.getElementById('final_bal').textContent = fmt(s.final_nominal));
  document.getElementById('eff_price') && (document.getElementById('eff_price').textContent = fmt(s.pv_total));
  document.getElementById('saving') && (document.getElementById('saving').textContent = fmt(s.saving));
  document.getElementById('cum_interest') && (document.getElementById('cum_interest').textContent = fmt(s.cumulative_interest));
  document.getElementById('real_rate') && (document.getElementById('real_rate').textContent = (s.real_annual*100).toFixed(4) + '%');
  document.getElementById('monthly_used') && (document.getElementById('monthly_used').textContent = fmt(s.monthly_used));
  document.getElementById('financed_amount') && (document.getElementById('financed_amount').textContent = fmt(s.financed_amount));
  document.querySelectorAll('input[type=range]').forEach(r=> updateRangeVisual(r));
  return s;
}

// wire up events
const uiInputs = [nominal, inflation, tax, document.getElementById('tax_on_real'), document.getElementById('loan_apr'), document.getElementById('use_loan_apr'), document.getElementById('pay_balloon'), price, cust_dep, tesla_contrib, monthly, nmonthly, balloon];
uiInputs.forEach(i=> i && i.addEventListener('input', refresh));
document.getElementById('downloadBtn') && document.getElementById('downloadBtn').addEventListener('click', ()=>{
  const html = '<!doctype html>\n' + document.documentElement.outerHTML;
  const blob = new Blob([html], {type:'text/html'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'pcp_playground_v6.html'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
});

// init
initRangeUI();
refresh();
</script>
</body>
</html>
